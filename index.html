<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Blockly Demo: Generating JavaScript</title>
  <script src="./node_modules/blockly/blockly_compressed.js"></script>
  <script src="./node_modules/blockly/blocks_compressed.js"></script>
  <script src="./node_modules/blockly/python_compressed.js"></script>
  <script src="./node_modules/blockly/msg/en.js"></script>
  <script src="./node_modules/blockly/generators/python/robotarium.js"></script>
  <script src="./node_modules/blockly/blocks/robotarium.js"></script>

  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }

    h1 {
      font-weight: normal;
      font-size: 140%;
    }

    textarea {
      width: 50%;
    }
  </style>
</head>

<body>
  <p>This is a work in progress of a block coding interface for the GTRI Robotarium</p>
  <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" onclick="showCode()">Show
    Python</button>
  <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
    onclick="alert('Still in development')">Run
    Python</button>
  </p>

  <div id="blocklyDiv" style="height: 480px; width: 80%;"></div>
  <div id="outputDiv">
  </div>
  <a id="download" href="" download="output.py">Download</a>

  <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
    <category name="Logic" colour="%{BKY_LOGIC_HUE}">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
    </category>
    <category name="Loops" colour="%{BKY_LOOPS_HUE}">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <block type="math_number">
            <field name="NUM">10</field>
          </block>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
    </category>
    <category name="Math" colour="%{BKY_MATH_HUE}">
      <block type="math_number">
        <field name="NUM">123</field>
      </block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
    </category>

    <category name="Variables" colour="%{BKY_TEXTS_HUE}">

    </category>

    <category name="Text" colour="%{BKY_TEXTS_HUE}">
      <block type="text"></block>
      <block type="text_length"></block>
      <block type="text_print"></block>
    </category>

    <category name="Robotarium" colur="%{BKY_LOGIC_HUE}">
      <block type="initialize"></block>
      <block type="new_robot"></block>
      <block type="end_initialize"></block>
      <block type="run_to_point"></block>
      <block type="display_image"></block>
      <block type="move_foreward"></block>
      <block type="turn"></block>
      <block type="end"></block>
    </category>
  </xml>

  <xml xmlns="https://developers.google.com/blockly/xml" id="startBlocks" style="display: none">
    <block type="initialize" x="20" y="20">
      <next>
        <block type="new_robot">
          <field name="name">Bob</field>
          <next>
            <block type="end_initialize">
              <next>
                <block type="display_image">
                  <next>
                    <block type="run_to_point">
                      <next>
                        <block type="end"></block>
                      </next>
                    </block>
                  </next>
                </block>
              </next>
            </block>
          </next>
        </block>
      </next>
    </block>
    
    <!-- <block type="controls_if" inline="false" x="20" y="20">
      <mutation else="1"></mutation>
      <value name="IF0">
        <block type="logic_compare" inline="true">
          <field name="OP">EQ</field>
          <value name="A">
            <block type="math_arithmetic" inline="true">
              <field name="OP">MULTIPLY</field>
              <value name="A">
                <block type="math_number">
                  <field name="NUM">6</field>
                </block>
              </value>
              <value name="B">
                <block type="math_number">
                  <field name="NUM">7</field>
                </block>
              </value>
            </block>
          </value>
          <value name="B">
            <block type="math_number">
              <field name="NUM">42</field>
            </block>
          </value>
        </block>
      </value>
      <statement name="DO0">
        <block type="text_print" inline="false">
          <value name="TEXT">
            <block type="text">
              <field name="TEXT">Don't panic</field>
            </block>
          </value>
        </block>
      </statement>
      <statement name="ELSE">
        <block type="text_print" inline="false">
          <value name="TEXT">
            <block type="text">
              <field name="TEXT">Panic</field>
            </block>
          </value>
        </block>
      </statement>
    </block> -->
  </xml>

  <script>
    var demoWorkspace = Blockly.inject('blocklyDiv',
      {
        media: 'https://unpkg.com/blockly/media/',
        toolbox: document.getElementById('toolbox')
      });
    Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'),
      demoWorkspace);

    function showCode() {
      // Generate JavaScript code and display it.
      Blockly.Python.INFINITE_LOOP_TRAP = null;
      var code = Blockly.Python.workspaceToCode(demoWorkspace);
      var para;
      var createdAlready = false;
      if (document.getElementById("output") == null) {
        console.log('here');
        para = document.createElement("textarea");
        createdAlready = false;
      }
      else {
        para = document.getElementById("output");
        para.innerHTML = "";
        createdAlready = true;
      }

      const node = document.createTextNode(code);
      para.appendChild(node);

      para.style.height = "auto";
      para.style.height = (this.scrollHeight) + "px";



      para.id = "output"

      if (!createdAlready) {
        const element = document.getElementById("outputDiv");
        element.appendChild(para);
      }

      const tx = document.getElementsByTagName("textarea");
      for (let i = 0; i < tx.length; i++) {
        tx[i].setAttribute("style", "height:" + (tx[i].scrollHeight) + "px;overflow-y:hidden;");
      }

      var pythonFile = null;
      console.log(code);
      var data = new Blob([code], { type: 'text/x-python' });

      if (pythonFile !== null) {
        window.URL.revokeObjectURL(pythonFile);
      }

      pythonFile = window.URL.createObjectURL(data);

      document.getElementById("download").href = pythonFile;
    }

    function runCode() {
      // Generate JavaScript code and run it.
      window.LoopTrap = 1000;
      Blockly.Python.INFINITE_LOOP_TRAP =
        'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
      var code = Blockly.Python.workspaceToCode(demoWorkspace);
      Blockly.Python.INFINITE_LOOP_TRAP = null;
      try {
        eval(code);
      } catch (e) {
        alert(e);
      }
    }
  </script>

</body>

</html>