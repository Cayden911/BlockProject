<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Robotarium Blockly WIP</title>

  <!-- where all of the block files are found --> 
  <script src="./node_modules/blockly/blockly_compressed.js"></script>
  <script src="./node_modules/blockly/blocks_compressed.js"></script>
  <script src="./node_modules/blockly/python_compressed.js"></script>
  <script src="./node_modules/blockly/msg/en.js"></script>
  <script src="./node_modules/blockly/blocks/lists.js"></script>
  <script src="./node_modules/blockly/blocks/colour.js"></script>

  <!--This where the python that creates the output of the custom blocks-->
  <script src="./node_modules/blockly/generators/python/robotarium.js"></script>
  <!--This where the JSON that creates the visual of the custom blocks-->
  <script src="./node_modules/blockly/blocks/robotarium.js"></script>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>

  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
    textarea {
      width: 50%;
    }
  </style>
  
</head>

<body onload="pingBackend()">
  <table>
    <tr>
      <td>
        <p>This is a work in progress of a block coding interface for the Georgia Tech Robotarium</p>
          <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" onclick="showCode()">Show Python</button>
          <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" onclick="simCode()">Simulate Python</button>
            <a id="download" download="output.py" style="color:white">
              <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" onclick="updateFile()">Download Python</button>
            </a>
            <img id="loading" src="https://th.bing.com/th/id/OIP.GKoJ4X3YZVvOp-5Krqk7qAHaHa?pid=ImgDet&rs=1" style="width: 30px; height: 30px; margin:-10px; margin-left: 5px;">
        </p>
      </td>
      <td style="width: 35%"></td>
      <td>
        <img src="robotarium_header.png" sizes="" style="height: 90px; float: right">
      </td>
    </tr>
  </table>
  
  <div id="blocklyDiv" style="height: 480px; width: 100%;"></div>
  <iFrame id="video" src="https://robotarium-simulator.herokuapp.com/static/uploads/video.mp4" style="width:100%; height:500px;display: none"></iFrame>
  <pre class="prettyprint" id = "code"></pre>
 
  <!-- The individual blocks are imported to the menu --> 
  <!-- This xml file is all of the blocks that will be in the toolbox on the left-->
  <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">

      <!-- Logic imported --> 
    <category name="Logic" colour="%{BKY_LOGIC_HUE}">
      <block type="controls_if"></block>
      <block type="controls_ifelse"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="logic_null"></block>
      <block type="logic_ternary"></block>      
    </category>

     <!-- loops imported --> 

    <category name="Loops" colour="%{BKY_LOOPS_HUE}">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <block type="math_number">
            <field name="NUM">10</field>
          </block>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
      <block type="controls_repeat"></block>
      <block type="controls_for"></block>
      <block type="controls_forEach"></block>
      <block type="controls_flow_statements"></block>
    </category>

      <!-- math imported --> 

    <category name="Math" colour="%{BKY_MATH_HUE}">
      <block type="math_number">
        <field name="NUM">123</field>
      </block>
      <block type="math_arithmetic">
        <value name="A">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="B">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="math_single">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">9</field>
          </shadow>
        </value>
      </block>
      <block type="math_trig">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">45</field>
          </shadow>
        </value>
      </block>
      <block type="math_constant"></block>
      <block type="math_number_property">
        <value name="NUMBER_TO_CHECK">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
      </block>
      <block type="math_round">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">3.1</field>
          </shadow>
        </value>
      </block>
      <block type="math_on_list"></block>
      <block type="math_modulo">
        <value name="DIVIDEND">
          <shadow type="math_number">
            <field name="NUM">64</field>
          </shadow>
        </value>
        <value name="DIVISOR">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="math_constrain">
        <value name="VALUE">
          <shadow type="math_number">
            <field name="NUM">50</field>
          </shadow>
        </value>
        <value name="LOW">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="HIGH">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_int">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_float"></block>
      <block type="math_atan2">
        <value name="X">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="Y">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
    </category>

<!--    <category name="Variables" colour="%{BKY_TEXTS_HUE}">

    </category> -->
  <!-- Text Blocks Imported --> 

    <category name="Text" colour="%{BKY_TEXTS_HUE}">
      <block type="text"></block>
      <block type="text_join"></block>
      <block type="text_append">
        <value name="TEXT">
          <shadow type="text"></shadow>
        </value>
      </block>
      <block type="text_length">
        <value name="VALUE">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_isEmpty">
        <value name="VALUE">
          <shadow type="text">
            <field name="TEXT"></field>
          </shadow>
        </value>
      </block>
      <block type="text_indexOf">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
        <value name="FIND">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_charAt">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
      </block>
      <block type="text_getSubstring">
        <value name="STRING">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
      </block>
      <block type="text_changeCase">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_trim">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_print">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_prompt_ext">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
    </category>


      <!-- List Blocks Imported --> 

    <category name="Lists" colour="%{BKY_LISTS_HUE}">
      <block type="lists_create_with">
        <mutation items="0"></mutation>
      </block>
      <block type="lists_create_with"></block>
      <block type="lists_repeat">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">5</field>
          </shadow>
        </value>
      </block>
      <block type="lists_length"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_indexOf">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_getIndex">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_setIndex">
        <value name="LIST">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_getSublist">
        <value name="LIST">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_split">
        <value name="DELIM">
          <shadow type="text">
            <field name="TEXT">,</field>
          </shadow>
        </value>
      </block>
      <block type="lists_sort"></block>
    </category>

      <!-- Color Blocks Imported --> 

    <category name="Colour" colour="%{BKY_COLOUR_HUE}">
      <block type="colour_picker"></block>
      <block type="colour_random"></block>
      <block type="colour_rgb">
        <value name="RED">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
        <value name="GREEN">
          <shadow type="math_number">
            <field name="NUM">50</field>
          </shadow>
        </value>
        <value name="BLUE">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
      </block>
      <block type="colour_blend">
        <value name="COLOUR1">
          <shadow type="colour_picker">
            <field name="COLOUR">#ff0000</field>
          </shadow>
        </value>
        <value name="COLOUR2">
          <shadow type="colour_picker">
            <field name="COLOUR">#3333ff</field>
          </shadow>
        </value>
        <value name="RATIO">
          <shadow type="math_number">
            <field name="NUM">0.5</field>
          </shadow>
        </value>
      </block>
    </category>

      <!-- Robotarium Blocks Imported --> 

    <category name="Robotarium" colur="%{BKY_LOGIC_HUE}">
      <block type="new_robot"></block>
      <block type="run_to_point"></block>
      <block type="display_image"></block>
      <block type="move_forward"></block>
      <block type="turn_by_angle"></block>
      <block type="turn_to"></block>
      <block type="pen_down"></block>
    </category>
  </xml>

  <!-- This xml file is the starting blocks that defalt in the begining-->
  <xml xmlns="https://developers.google.com/blockly/xml" id="startBlocks" style="display: none">
    <block type="new_robot">
      <field name="name">Bob</field>
      <next>
        <block type="run_to_point">
          <field name="target_x">.8</field>
          <field name="target_y">.8</field>
        </block>
      </next>
    </block> 
  </xml>

  <script>
    var demoWorkspace = Blockly.inject('blocklyDiv',
      {
        media: 'https://unpkg.com/blockly/media/',
        toolbox: document.getElementById('toolbox')
      });

    Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'),demoWorkspace);
    
    function updateFile(){
      Blockly.Python.INFINITE_LOOP_TRAP = null;
      var fr = new FileReader();
      var rpsString = "import rps.robotarium as robotarium";
      
      var initialize = `
import rps.robotarium as robotarium
from rps.utilities.transformations import *
from rps.utilities.barrier_certificates import *
from rps.utilities.misc import *
from rps.utilities.controllers import *

import numpy as np
import time
import math

class Robot:

    def __init__(self, name, x, y, t, drawing):
        self.target_points = []
        self.currentPoint = 0
        self.totalPoints = 0
        self.finished = False
        self.output_points = np.array([[],[],[]])
        t=t%360
        if(t>180):
            t=t-360
        theta = t * 3.14/180
        self.name = name
        self.start_array = np.array([[x],[y],[theta],[drawing]])
        self.target_points.append((x,y,theta,drawing))
        self.output_points = np.array([[x],[y],[theta],[drawing]])
    
    def add_Target_Point(self,x,y,t,drawing):
        self.totalPoints = self.totalPoints + 1
        t=t%360
        if(t>180):
            t=t-360
        self.target_points.append((x,y,t*3.14/180,drawing))

    def get_Target_Points(self):
        return self.target_points

    def update_Output_Points(self):
        self.output_points[0] = self.target_points[self.currentPoint][0]
        self.output_points[1] = self.target_points[self.currentPoint][1]
        self.output_points[2] = self.target_points[self.currentPoint][2]
        self.output_points[3] = self.target_points[self.currentPoint][3]
    
    def step_Current_Point(self):
        self.currentPoint = self.currentPoint + 1
        if(self.currentPoint > self.totalPoints):
            self.finished = True
        if(not self.finished):
            self.update_Output_Points()
    
    def get_Output_Points(self):
        return self.output_points

    def angle_In_Range(self, angle, accuracy = .07):
        if((self.target_points[self.currentPoint][2]-accuracy< angle< self.target_points[self.currentPoint][2]+accuracy)):
            return True
        else:
            return False

    def check_Position(self,robot_num, pos, accuracy = .03):
        if(not self.finished):
            if((self.target_points[self.currentPoint][0]-accuracy< pos[0][robot_num] < self.target_points[self.currentPoint][0]+accuracy) and (self.target_points[self.currentPoint][1]-accuracy< pos[1][robot_num] < self.target_points[self.currentPoint][1]+accuracy) and (self.angle_In_Range(pos[2][robot_num]))):
                self.step_Current_Point()
                return True
            else:
                return False

    def get_Status(self):
        return self.finished

    def move_Forward(self, distance, drawing):
        curX = self.target_points[self.totalPoints][0]
        curY = self.target_points[self.totalPoints][1]
        curT = self.target_points[self.totalPoints][2]
        addX = distance * math.cos(curT)
        addY = distance * math.sin(curT)
        self.add_Target_Point((curX+addX),(curY+addY),(curT*180/3.14),drawing)
    
    def turn(self,by):
          curX = self.target_points[self.totalPoints][0]
          curY = self.target_points[self.totalPoints][1]
          curT = self.target_points[self.totalPoints][2]*180/3.14
          curT = (curT + by)%360
          self.add_Target_Point((curX),(curY),(curT))

robotList = []
namesList = []
robotColorsList = []
robot_labels = []
t_end = time.time() + 60 * 5
drawing = -1

def Fill_Start_Array():
    start_Array = np.array([[],[],[],[]])
    for robot in robotList:
        start_Array = np.append(start_Array,robot.get_Output_Points(), axis = 1)
    return start_Array

def Update_Target_Array(pos):
    target_Array = np.array([[],[],[],[]])
    for i in range(len(robotList)):
        robotList[i].check_Position(i,pos)
        target_Array = np.append(target_Array,robotList[i].get_Output_Points(), axis = 1)
    return target_Array

def Check_if_All_Done():
    for robot in robotList:
        if(robot.get_Status() == False):
            return False
    return True

def New_Robot(name, x,y,t,color,drawing):
    namesList.append(name)
    robotList.append(Robot(name,x,y,t,drawing))
    robotColorsList.append(color)

def Add_Target_Point(name, x,y,t,drawing):
    robotList[namesList.index(name)].add_Target_Point(x,y,t,drawing)
`;
      var end = `
start_Array = Fill_Start_Array()
r = robotarium.Robotarium(number_of_robots=len(robotList), show_figure=True, initial_conditions=start_Array[0:3][:], sim_in_real_time=False)
unicycle_position_controller = create_hybrid_unicycle_pose_controller()
uni_barrier_cert = create_unicycle_barrier_certificate()
_,uni_to_si_states = create_si_to_uni_mapping()
x = r.get_poses()
r.step()

robot_labels = [r.axes.text(x[0,namesList.index(kk)],x[1,namesList.index(kk)]+0.15,kk,fontsize=8, color=robotColorsList[namesList.index(kk)],fontweight='bold',horizontalalignment='center',verticalalignment='center',zorder=0)
for kk in namesList]


ii = 0

while time.time() < t_end:
    x = r.get_poses()
    xi =  uni_to_si_states(x)

    dxu = unicycle_position_controller(x, Update_Target_Array(x))
    dxu = uni_barrier_cert(dxu, x)
    r.set_velocities(np.arange(len(robotList)), dxu)    
    
    for i in range(len(robotList)):
      if robotList[i].get_Status() == False:
        if robotList[i].get_Target_Points()[robotList[i].currentPoint][3] != -1  and ii == 0 :
          tempColor = hex(int(robotList[i].get_Target_Points()[robotList[i].currentPoint][3]))
          tempColor = "#" + tempColor[2:]
          r.axes.plot(x[0][i],x[1][i],color=tempColor, marker='o', linestyle='dashed', linewidth=1, markersize=6)
          drawFrame = True
        
    
    if(drawFrame):
      ii = 20
      drawFrame = False
    if ii > 0:
      ii -= 1
    
    


    #draws names
    for robotname in namesList:
      nameindex = namesList.index(robotname)
      robot_labels[nameindex].set_position([xi[0,nameindex],xi[1,nameindex]+0.15])
      
    
    r.step()
    if(Check_if_All_Done()):
        break

r.call_at_scripts_end()
`;
var code = initialize + Blockly.Python.workspaceToCode(demoWorkspace) + end;
var pythonFile = null;
      var data = new Blob([rpsString+code], { type: 'text/x-python' });

      if (pythonFile !== null) {
        window.URL.revokeObjectURL(pythonFile);
      }

      pythonFile = window.URL.createObjectURL(data);

      document.getElementById("download").href = pythonFile;
      return code;
    }


    function showCode() {
      var rpsString = "import rps.robotarium as robotarium";
      updateFile();
      

      document.getElementById("code").style.height = "auto";
      document.getElementById("code").innerHTML = rpsString + updateFile();
    
    }

  

    function recived(){//When recived 
      const myTimeout = setTimeout(function(){
        var code = document.getElementById('video');
      code.src = code.src;
  
      document.getElementById("video").style.display = "block"

      var code = document.getElementById('video');
      code.src = code.src;
      document.getElementById("loading").src = "https://th.bing.com/th/id/OIP.GKoJ4X3YZVvOp-5Krqk7qAHaHa?pid=ImgDet&rs=1"
      window.scrollTo(0, document.body.scrollHeight);
    }, 6000)
    }

    function pingBackend(){
      document.getElementById("loading").src = "https://th.bing.com/th/id/OIP.GKoJ4X3YZVvOp-5Krqk7qAHaHa?pid=ImgDet&rs=1"
      var requestOptions = {
        mode: 'no-cors',
        method: 'GET',
        redirect: 'follow'
      };
      fetch("https://simulator-server.herokuapp.com", requestOptions)
        .then(response => response.text())
        .then(result =>console.long(response))
        .catch(error => console.log('error', error));
    }

    function simCode() {
      var formdata = new FormData();
      document.getElementById("video").style.display = "none"
      document.getElementById("loading").src = "https://media1.tenor.com/images/d6cd5151c04765d1992edfde14483068/tenor.gif?itemid=5662595"
      var rpsStirngNorps = "import robotarium as robotarium";
      formdata.append("code", rpsStirngNorps + updateFile());
      var requestOptions = {
        mode: 'no-cors',
        method: 'POST',
        body: formdata,
        redirect: 'follow'
      };
      try{
      fetch("https://simulator-server.herokuapp.com/simulationVideo", requestOptions)
        .then(result => recived())
        .catch((error) => {
          alert("There has been an error in the server, please try again later")
        });
      }catch(err){
        alert("There has been an error in the server, please try again later")
      }
        
    }
  </script>

</body>

</html>